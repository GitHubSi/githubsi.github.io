<!DOCTYPE html>
<html>

<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">

<meta name="description" content="Hugo-Primer theme&#39;s example site">
<title>
    database package - 渐行渐远
</title>









<link rel="stylesheet" href="/css/main.min.670da4c21f08f6fb9346ba65b362026a143c88c6d6e4292b05476774b0516a42.css" integrity="sha256-Zw2kwh8I9vuTRrpls2ICahQ8iMbW5CkrBUdndLBRakI=" crossorigin="anonymous" media="screen">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="database package"/>
<meta name="twitter:description" content="清除无效连接 在database库下清除过期连接时，使用了如下的代码逻辑。其中freeConn是空闲连接池，d是连接可被重复使用的最长时间，n"/>

<meta property="og:title" content="database package" />
<meta property="og:description" content="清除无效连接 在database库下清除过期连接时，使用了如下的代码逻辑。其中freeConn是空闲连接池，d是连接可被重复使用的最长时间，n" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://neojos.com/blog/2019/19-06-03-database-package/" />
<meta property="article:published_time" content="2019-06-03T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2019-06-03T00:00:00&#43;00:00"/>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-12345678-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    

    
    
    
    <title>
        
        database package
        
    </title>
</head>

<body>
    
    
    <header class="wrap flex-container">
        <h1>database package</h1>
    </header>
    
    <main class="wrap">
        
        <article role="article" class="flex-container">

<h2 id="清除无效连接">清除无效连接</h2>

<p>在database库下清除过期连接时，使用了如下的代码逻辑。其中freeConn是空闲连接池，d是连接可被重复使用的最长时间，nowFunc返回的是当前时间。最新生成的连接在freeConn的末尾，而清除的过程则是使用最新的、次新的连接依次替换最早过期的、次早过期的连接。</p>

<p>在for循环中直接使用len来获取总计数，在循环体内部将freeConn末尾的值替换首部的值，并将freeConn的len长度减去1。最后还做了<code>i—</code>操作，重复校验了一次。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">expiredSince</span> <span class="o">:=</span> <span class="nf">nowFunc</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="o">-</span><span class="nx">d</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">closing</span> <span class="p">[]</span><span class="o">*</span><span class="nx">driverConn</span>
<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">db</span><span class="p">.</span><span class="nx">freeConn</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">freeConn</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">.</span><span class="nf">Before</span><span class="p">(</span><span class="nx">expiredSince</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">closing</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">closing</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
		<span class="nx">last</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">db</span><span class="p">.</span><span class="nx">freeConn</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
		<span class="nx">db</span><span class="p">.</span><span class="nx">freeConn</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">freeConn</span><span class="p">[</span><span class="nx">last</span><span class="p">]</span>
		<span class="nx">db</span><span class="p">.</span><span class="nx">freeConn</span><span class="p">[</span><span class="nx">last</span><span class="p">]</span> <span class="p">=</span> <span class="kc">nil</span>
		<span class="nx">db</span><span class="p">.</span><span class="nx">freeConn</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">freeConn</span><span class="p">[:</span><span class="nx">last</span><span class="p">]</span>
		<span class="nx">i</span><span class="o">--</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></div>
<h3 id="参考点">参考点</h3>

<p>slice中首部和尾部数据的交换过程，以及每次通过<code>i--</code>达到的重复校验的思路。</p>

<h2 id="间隔执行">间隔执行</h2>

<p>清除无效连接的工作是由一个goroutine在后台完成的，下面是截取的部分代码。for循环内部是处理连接的具体实现。每次清除操作完成后，通过Reset来重置Timer。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">connectionCleaner</span><span class="p">(</span><span class="nx">d</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="nx">minInterval</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>

	<span class="k">if</span> <span class="nx">d</span> <span class="p">&lt;</span> <span class="nx">minInterval</span> <span class="p">{</span>
		<span class="nx">d</span> <span class="p">=</span> <span class="nx">minInterval</span>
	<span class="p">}</span>
	<span class="nx">t</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTimer</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>

	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">t</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">db</span><span class="p">.</span><span class="nx">cleanerCh</span><span class="p">:</span> <span class="c1">// maxLifetime was changed or db was closed.
</span><span class="c1"></span>		<span class="p">}</span>

		<span class="k">if</span> <span class="nx">d</span> <span class="p">&lt;</span> <span class="nx">minInterval</span> <span class="p">{</span>
			<span class="nx">d</span> <span class="p">=</span> <span class="nx">minInterval</span>
		<span class="p">}</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></div>
<h3 id="参考点-1">参考点</h3>

<p>学习NewTimer函数的使用，它在声明后仅仅执行一次。通过Reset来重新使他生效。这样可以忽略操作执行的具体时间，每次都在上次操作完成后，间隔固定时间，再执行下一次操作。</p>

<p>还可以对比NewTicker做比较。</p>

<h2 id="获取连接">获取连接</h2>

<p>从freeConn中获取一个缓存的连接，拿到连接之后并将它从freeConn中移除。同时，校验连接是否已经超过最大连接使用时间。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="k">if</span> <span class="nx">strategy</span> <span class="o">==</span> <span class="nx">cachedOrNewConn</span> <span class="o">&amp;&amp;</span> <span class="nx">numFree</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
	<span class="nx">conn</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">freeConn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
	<span class="nb">copy</span><span class="p">(</span><span class="nx">db</span><span class="p">.</span><span class="nx">freeConn</span><span class="p">,</span> <span class="nx">db</span><span class="p">.</span><span class="nx">freeConn</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
	<span class="nx">db</span><span class="p">.</span><span class="nx">freeConn</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">freeConn</span><span class="p">[:</span><span class="nx">numFree</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
	<span class="nx">conn</span><span class="p">.</span><span class="nx">inUse</span> <span class="p">=</span> <span class="kc">true</span>
	<span class="nx">db</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">expired</span><span class="p">(</span><span class="nx">lifetime</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">conn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">ErrBadConn</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">conn</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span></code></pre></div>
<h3 id="参考点-2">参考点</h3>

<p>使用copy对slice的第一个元素进行移除。同时，通过重新赋值来修改slice的len属性。</p>
</article>
        

        
        
        
    </main>
    
    <footer class="flex-container footer"></footer>
    
    
</body>

</html>