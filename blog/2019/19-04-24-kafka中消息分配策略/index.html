<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Kafka中消息分配策略 - 渐行渐远</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css">
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="渐行渐远" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/img/placeholder.png">
				</div><div class="logo__item logo__text">
					<div class="logo__title">渐行渐远</div>
					<div class="logo__tagline">往者不可谏，来者犹可追</div>
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kafka中消息分配策略</h1>
			<div class="post__meta meta"><div class="meta__item-author meta__item">
	<svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2 0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class="meta__text">Neojos</span>
</div>
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2019-04-24T00:00:00Z">2019-04-24</time></div></div>
		</header>
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#question"><code>Question</code></a></li>
<li><a href="#sense"><code>sense</code></a></li>
<li><a href="#thinking"><code>Thinking</code></a>
<ul>
<li><a href="#1-1"><code>1:1</code></a></li>
<li><a href="#1-2"><code>1:2</code></a></li>
<li><a href="#2-1"><code>2:1</code></a></li>
<li><a href="#2-2"><code>2:2</code></a></li>
<li><a href="#结论">结论</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
	</div>
</div>
<div class="content post__content clearfix">
			

<blockquote>
<p><code>非淡泊无以明，非宁静无以致远</code></p>
</blockquote>

<h2 id="question"><code>Question</code></h2>

<p>关于<code>kafka</code>中<code>partation</code>和<code>consumer</code>的是如何执行分配的。今早骑自行车的时候突然想起这个问题。它是怎么分配的，我记得我看到好几次相关的介绍文章，现在却想不起来？</p>

<h2 id="sense"><code>sense</code></h2>

<p>很多时候，我们在看完一篇技术文档时，感觉对其中的内容都了解了，其实不然。这也是所谓的被动输入和主动输出的区别所在。相比主动输出而言，被动输入缺少了深层思考的态度。得到一些老师的课里就谈到过主动输出的重要性。</p>

<p>很多概念都已经记不起来了，文章的内容可能也不够准确，但重在思考和想法的过程：</p>

<h2 id="thinking"><code>Thinking</code></h2>

<p><code>partaion</code>是数据的存储单位，一个<code>topic</code>至少存在一个<code>partation</code>。<code>consumer</code>使用主动拉数据的方式来消费消息，这就是所有已知概念。那么<code>partation</code>和<code>consumer</code>是如何分配的呢？这里我们假设消息数据总量是一样的。</p>

<p>首先，应该存在一个类似<code>LVS</code>的负载均衡器，因为当<code>consumer</code>增加或者减少时，对应的分配策略也需要做相应的调整。在<code>consumer</code>注册成为消费者时，提交的信息中有<code>consumer Group</code>的概念，这非常好理解，即同一个组的<code>consumer</code>会独立处理一份数据。同时，因为有了<code>Group</code>，我们在管理的时候就会简单很多。当然，所有的讨论都是以一个<code>Group</code>为前提的。</p>

<h3 id="1-1"><code>1:1</code></h3>

<p>从最简单的开始考虑，假设现在<code>partation</code>和<code>consumer</code>的数量比例是<code>1:1</code>，那就没有那么多事了，简单明了。</p>

<h3 id="1-2"><code>1:2</code></h3>

<p>假设是<code>1:2</code>呢？问题来了，好比现在只有一个数据，但有<code>AB</code>两个线程都要读它，且<code>A</code>和<code>B</code>中有且只有一个能读到。这种情况在计算机中相当普遍，通用的处理方式就是加锁，以保证数据只被其中一个线程处理。但加锁就意味着性能开销，尤其是高并发的场景。</p>

<p>继续按照这个思路来考虑，两个<code>consumer</code>同时向一个<code>partation</code>发起请求，需要一个全局锁来控制每个消息只能返回给请求中的一个。相比较<code>1:1</code>的方式，这样的性能肯定是提高了不少。</p>

<h3 id="2-1"><code>2:1</code></h3>

<p>假设是<code>2:1</code>呢？这个也很直观，两份数据，但只有一个消费者，那肯定都需要这一个消费者来处理了，就跟<code>CPU</code>任务调度还有些类似。</p>

<p>如果跟<code>1:2</code>的分配策略比较呢？这里通过将原来的一份数据平均分成两份，去掉了<code>1:2</code>中加锁的开销，但只有一个<code>connsumer</code>来消费数据。好比是单核<code>CPU</code>任意处理数据跟双核<code>CPU</code>加锁处理数据。</p>

<h3 id="2-2"><code>2:2</code></h3>

<p>假设是<code>2:2</code>呢，我们可以平均分配<code>partation</code>和<code>consumer</code>，而且这样系统性能却得到最大提升，不仅去掉了锁的开销，还有两个线程来同时消费。</p>

<h3 id="结论">结论</h3>

<p>通过上面的对比，我们可以清楚的发现，通过调整<code>partation</code>和<code>consumer</code>的数量就可以将系统性能达到最大，完全不需要引入锁机制。这样想的话，分配就很简单了。</p>

		</div>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Neojos avatar" src="/img/avatar.png" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Neojos</span>
	</div>
	<div class="authorbox__description">
		John Doe&rsquo;s true identity is unknown. Maybe he is a successful blogger or writer. Nobody knows it.
	</div>
</div>

<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/blog/2019/19-04-21-go-module%E4%B8%80/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Go Module（一）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/blog/2019/19-04-27-mongo-eof/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">mongo EOF</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 John Doe.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
<script src="/js/custom.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>