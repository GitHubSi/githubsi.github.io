<!DOCTYPE html>
<html>

<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">

<meta name="description" content="Hugo-Primer theme&#39;s example site">
<title>
    Deafult Decimal - 渐行渐远
</title>









<link rel="stylesheet" href="/css/main.min.ea2156633063385371d7a4d9db559868e643a3885ab887da32f7ea8a1e05ee11.css" integrity="sha256-6iFWYzBjOFNx16TZ21WYaOZDo4hauIfaMvfqih4F7hE=" crossorigin="anonymous" media="screen">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic">
<script
        src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        crossorigin="anonymous"></script>

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Deafult Decimal"/>
<meta name="twitter:description" content="版本 0.00 我说：version dependent 表示我们的思考时，应该依赖具体的版本。举个例子，你把2015年看到的一些redis机制拿到现在跟别人谈论，很容易"/>

<meta property="og:title" content="Deafult Decimal" />
<meta property="og:description" content="版本 0.00 我说：version dependent 表示我们的思考时，应该依赖具体的版本。举个例子，你把2015年看到的一些redis机制拿到现在跟别人谈论，很容易" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://neojos.com/blog/2018/12-01-deafult-decimal/" />
<meta property="article:published_time" content="2018-12-01T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2018-12-01T00:00:00&#43;00:00"/>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-12345678-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    

    
    
    
    <title>
        
        Deafult Decimal
        
    </title>
</head>

<body>

    
    
    <header class="text-center container">
        <h1 class="mb-4 mt-2">Deafult Decimal</h1>
    </header>
    
    <main class="wrap">
        
<div class="container">
    <aside role="complementary">
        <div class="tag-container">
            
            
            <span class="tag">
                <a href="/tags/mysql/" class="badge badge-success">
                    MySQL
                </a>
            </span>
            
            
        </div>
        <div class="float-right badge badge-light">12-01-2018 &#183; 943 words</div>
    </aside>
    <hr />
    <article role="article">
        

<p><em><u>版本 0.00</u></em></p>

<blockquote>
<p>我说：<code>version dependent</code> 表示我们的思考时，应该依赖具体的版本。举个例子，你把2015年看到的一些<code>redis</code>机制拿到现在跟别人谈论，很容易闹出笑话。在3年的时间里，它可能已经做了无数的优化。所以，思考要与时俱进。</p>
</blockquote>

<h2 id="引言">引言</h2>

<h3 id="在涉及到支付业务的时候-数据库里的钱怎么存">在涉及到支付业务的时候，数据库里的钱怎么存：</h3>

<ol>
<li>存储单位是元。在业务处理的时候就会涉及到浮点数，很多商家喜欢将价钱定义为<code>0.99</code>而不是<code>1</code>元。这在使用过程中非常忌讳<strong>是否相等</strong>的比较。浮点数的比较经常喜欢用<code>|floatA - floatB| &gt; 0.00001</code>来，很多第三方库也提供了比较方法。</li>
<li>存储单位时分。为了避免浮点类型比较时的不确定性，决定使用整形来替代。一般来说没有问题，可如果是要严格缺心眼打折，比如给一个售价<code>4.99</code>的打<code>5折</code>，那么最后就会存在<code>5里</code>的情况。一般都喜欢向上取整，应收用户<code>2.495</code>，实收用户<code>2.50</code>.</li>
</ol>

<h3 id="那么在-mysql-的-column-中该如何存储呢">那么在<code>MySQL</code>的<code>Column</code>中该如何存储呢？</h3>

<ol>
<li>如果是分的话，肯定时当整形来存储的。但如果时浮点的，大家都会选择<code>decimal</code>，因为该类型不会丢失精度。</li>
<li>存储为字符串。浮点数保留指定位数的字符串。在<code>Go</code>中我也尝试过，<code>fmt.Sprintf(&quot;%.2f&quot;, 3.091)</code>还是靠谱的。</li>
</ol>

<p>这篇文章当然不是来分析这两种存储方式的，也不是来分析该存储什么数据类型的。而仅仅时想阐述一个之前不了解的知识点（知识点太少，写点别的来凑）。</p>

<h2 id="deault-value"><code>deault value</code></h2>

<p>在<code>MySQL</code>建表的过程中，一般都会指定<code>DEFAULT VALUE</code>。在执行<code>INSERT</code>时，如果不指定该字段，<code>MySQL</code>会默认使用该默认值来替代。下面是创建的一个<code>decimal</code>类型字段，在<code>Go</code>中使用<a href="https://github.com/go-xorm/xorm"><code>xorm</code></a> 来表示，可以看出，<code>xorm</code>使用字符串类型来接收<code>decimal</code>类型的值。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">table_test</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">PayPrice</span>  <span class="kt">string</span>  <span class="s">`xorm:&#34;not null default 0.00 comment(&#39;支付价钱&#39;) DECIMAL(10,2)&#34;`</span>
<span class="p">}</span></code></pre></div>
<p>最后发现：在测试环境下，向数据库插入记录时，不指定<code>PayPrice</code>没有任何问题。但到了正式服数据表插入便失败了。报错信息如下：</p>

<pre><code>{
    &quot;Number&quot;: 1366,
    &quot;Message&quot;: &quot;Incorrect decimal value: '' for column 'pay_price' at row 1&quot;
}
</code></pre>

<h2 id="strict-trans-tables"><code>STRICT_TRANS_TABLES</code></h2>

<p>查询<code>sql_mode</code>如下：</p>

<pre><code>show variables like 'sql_mode'
</code></pre>

<p>下面的内容截取至:<a href="https://dev.mysql.com/doc/refman/8.0/en/sql-mode.html#sql-mode-strict"><code>Strict SQL Mode</code></a>:</p>

<blockquote>
<p><code>Strict mode controls how MySQL handles invalid or missing values in data-change statements such as INSERT or UPDATE. A value can be invalid for several reasons. For example, it might have the wrong data type for the column, or it might be out of range.</code></p>
</blockquote>

<p>最终定位：<strong>空字符串在该模式下转换decimal会失败，测试和线上数据库环境不一致</strong></p>

    </article>
</div>


        
<nav role="navigation" class="bottom-menu">
    

    
        <a href="/blog">back</a>
        
    

    
</p>
</nav>

    </main>
    
    <footer class="container footer"></footer>
    
    
</body>

</html>