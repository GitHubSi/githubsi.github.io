<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>NSS初窥 - 渐行渐远</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	<link rel="stylesheet" href="/css/custom.css">
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo logo--mixed">
		<a class="logo__link" href="/" title="渐行渐远" rel="home">
			<div class="logo__item logo__imagebox">
					<img class="logo__img" src="/img/placeholder.png">
				</div><div class="logo__item logo__text">
					<div class="logo__title">渐行渐远</div>
					<div class="logo__tagline">往者不可谏，来者犹可追</div>
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">NSS初窥</h1>
			<div class="post__meta meta"><div class="meta__item-author meta__item">
	<svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2 0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class="meta__text">Neojos</span>
</div>
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2018-11-20T00:00:00Z">2018-11-20</time></div></div>
		</header>
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#wireshark-配置"><code>wireshark</code>配置</a></li>
<li><a href="#key-log-文件格式"><code>key log</code>文件格式</a></li>
<li><a href="#tls-加解密"><code>TLS</code>加解密</a>
<ul>
<li><a href="#case-1"><code>case 1.</code></a>
<ul>
<li><a href="#关于-change-cipher-spec-protocol">关于<code>Change Cipher Spec Protocol</code></a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
	</div>
</div>
<div class="content post__content clearfix">
			

<p><em><u>版本 0.01</u></em></p>

<p>在使用<code>wireshark</code>分析<code>https</code>时，加密传输的内容会解析失败。而<code>NSS</code>可以存储<code>TLS</code>握手过程中的<code>Key</code>，用于解密。很好奇，它是如何实现的？</p>

<h2 id="wireshark-配置"><code>wireshark</code>配置</h2>

<pre><code> Edit→Preferences→Protocols→SSL→(Pre)-Master-Secret log filename.
</code></pre>

<h2 id="key-log-文件格式"><code>key log</code>文件格式</h2>

<p>文件的格式：<code>&lt;Label&gt; &lt;space&gt; &lt;ClientRandom&gt; &lt;space&gt; &lt;Secret&gt;</code></p>

<p>比较常见的<code>Label</code>和对应日志的内容:</p>

<pre><code>CLIENT_HANDSHAKE_TRAFFIC_SECRET
CLIENT_RANDOM
CLIENT_TRAFFIC_SECRET_0
EXPORTER_SECRET
SERVER_HANDSHAKE_TRAFFIC_SECRET
SERVER_TRAFFIC_SECRET_0
</code></pre>

<pre><code>CLIENT_RANDOM 8e40057e8e1c32f42faf87ddc17a81da9e02aa6c4ef4fcec2dcb504982e50691 0df84b6a904cb47940666a9e198dceab94b58dd0f0e61775db52716a37759d25b600b44601b541f5b21669ef0814770e
CLIENT_HANDSHAKE_TRAFFIC_SECRET 9aef967472d9d65bf269989ac68c68c6374fd8c2cf9edf98c91593c8df7ffa3f 23b0b29e3edfe6e53114c6d9cb85159902462801c5540fc806c09f5d1711d992
CLIENT_TRAFFIC_SECRET_0 cd12af49c901682f29777821369c167854b047ac27a6a85c3db9dce565debbcf f826d8181c8b751cafd8c60bdbe2e4a4974113eea2a46c2a615e2115d70c9544
EXPORTER_SECRET 51c27befc24dceb18ade59b4a10c1398725848f7130b2ebeeb2e01483ed95e4d 58cc23d6d1db1e674200f7457dc9833ec826a5faf71830a6c5d3f4e63fa2144f
</code></pre>

<h2 id="tls-加解密"><code>TLS</code>加解密</h2>

<h3 id="case-1"><code>case 1.</code></h3>

<p>使用<code>wireshark</code>抓取一个<code>TLS</code>的握手过程来简单示例。其中<code>Client Key Exchange, Change Cipher Spec, Encrypted Handshake Message</code>在一个数据包中返回。</p>

<p><img src="https://i.loli.net/2018/11/21/5bf4acc7064a5.png" alt="image" /></p>

<p>我在网上找到了严格一致的流程分析图（画的真不错）。</p>

<p><img src="https://i.loli.net/2018/11/21/5bf4acc4377c4.png" alt="image" /></p>

<p>计算对称密钥的过程:</p>

<ol>
<li>在<code>Client Hello</code>阶段生成<code>random_C</code></li>
<li>在<code>Server Hello</code>阶段生成<code>random_S</code></li>
<li>在<code>Client Key Exchange</code>阶段，客户端根据这两个随机数，生成<code>Pre-master</code>，并用公钥加密，发送给服务端</li>
<li><code>Change Cipher Spec</code>阶段，服务端私钥解密，获取<code>PRe-master</code>，用同样的算法计算加密密钥。</li>
</ol>

<h4 id="关于-change-cipher-spec-protocol">关于<code>Change Cipher Spec Protocol</code></h4>

<blockquote>
<p>The change cipher spec protocol is used to change the encryption being used by the client and server. It is normally used as part of the handshake process to switch to symmetric key encryption. The CCS protocol is a single message that tells the peer that the sender wants to change to a new set of keys, which are then created from information exchanged by the handshake protocol.</p>
</blockquote>

<p>实际上用于通知<code>peer</code>使用当前协商的密钥进行通讯</p>

<hr />

<p>参考文章：</p>

<ol>
<li><a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/NSS/Key_Log_Format"><code>NSS Key Log Format
</code></a></li>
<li><a href="http://iluoxuan.iteye.com/blog/1736275"><code>SSL身份认证原理</code></a></li>
</ol>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/tcp/ip/" rel="tag">tcp/ip</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Neojos avatar" src="/img/avatar.png" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Neojos</span>
	</div>
	<div class="authorbox__description">
		John Doe&rsquo;s true identity is unknown. Maybe he is a successful blogger or writer. Nobody knows it.
	</div>
</div>

<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/blog/2018/11-03-singleton-pattern/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">singleton pattern</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/blog/2018/12-01-deafult-decimal/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Deafult Decimal</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 John Doe.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
<script src="/js/custom.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script>
</body>
</html>